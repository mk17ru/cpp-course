# Класcификация комбинаций

## Теоретическое введение

 На современных электронных финансовых рынках торгуется множество видов финансовых инструментов - акции (share), облигации (bond), фьючерсные (future contract) и форфардные (forward contract) контракты, различные типы опционов и т.д. Отдельным видом финансовых инструментов являются комбинации.

 _Комбинацией_ называется композитный финансовый инструмент, состоящий из множества инструментов и сопоставленных им весов:

![C=(I_1, w_1), (I_2, w_2), \.\.\., (I_N, w_N)](https://render.githubusercontent.com/render/math?math=C%3D(I_1%2C%20w_1)%2C%20(I_2%2C%20w_2)%2C%20%5C.%5C.%5C.%2C%20(I_N%2C%20w_N))

где ![I_1, I_2, \.\.\. , I_N](https://render.githubusercontent.com/render/math?math=I_1%2C%20I_2%2C%20%5C.%5C.%5C.%20%2C%20I_N) - произвольные финансовые инструменты (_компоненты_), а ![w_1, w_2, \.\.\. , w_N](https://render.githubusercontent.com/render/math?math=w_1%2C%20w_2%2C%20%5C.%5C.%5C.%20%2C%20w_N) - соотвествующие им веса (![w_1, w_2, \.\.\. , w_N \in R](https://render.githubusercontent.com/render/math?math=w_1%2C%20w_2%2C%20%5C.%5C.%5C.%20%2C%20w_N%20%5Cin%20R)). Покупка (продажа) комбинации влечет за собой приобретение (продажу) компонент с положительным весом и продажу (покупку) компонент с отрицательным весом. Простым примером комбинации может быть фондовый индекс.

 Далее полезно будет знать что такое опцион. _Опционом_ называется финансовый инструмент, дающий право его владельцу купить (колл опцион, call option) или продать (пут опцион, put option) базовый актив (например, акцию) по определенной цене (цена исполнения, strike price) в определенный момент в будущем (дата исполнения, expiration date).

 Комбинации, как и другие финансовые инструменты, могут быть различных типов. Например комбинация состоящая из одного колл и одного пут опционов с одинаковыми ценами и датами исполнения называется _стреддл_ (straddle). А если цена исполнения пут опциона меньше цены исполнения колл опциона (даты истечения одинаковы), то комбинация называется _стренгл_ (strangle).

## Постановка проблемы

 Задача состоит в определении типа комбинации по ее структуре и свойствам компонент.

## Описание формата ресурса

Множество всех типов описано в виде XML-ресурса. Каждая комбинация описыватеся тегом &lt;combination&gt;:

```xml
<combination name="Straddle" shortname="Str" identifier="da5a2620-575b-11df-9029-c3f2a99ff460">
	<!-- ... -->
</combination>
```

Обязательными атрибутами тега &lt;combination&gt; являются полное имя типа комбинации (name), короткое имя (shortname) и UUID индетификатор (identifier).
Внутри тега &lt;combination&gt; описываются компоненты комбинации:

```xml
<combination name="Straddle" shortname="Str" identifier="da5a2620-575b-11df-9029-c3f2a99ff460">
	<legs cardinality="fixed">
		<!-- ... -->
	</legs>
</combination>
```

У тега &lt;legs&gt; есть обязательный атрибут - количество компонент у комбинаций такого типа (cardinality). Существуют несколько возможных значений атрибута:
1. **fixed**: количество компонент фиксировано и равно количество описанному в ресурсе.
3. **multiple**: количество компонент кратно количеству описанному в ресурсе.
4. **more**: количество компонент должно быть больше либо равно, чем указано в атрибуте **mincount**

Внутри тега &lt;legs&gt; описаны компоненты комбинаций сооветствующего типа:

```xml
<combination name="Straddle" shortname="Str" identifier="da5a2620-575b-11df-9029-c3f2a99ff460">
	<legs cardinality="fixed">
		<leg type="C" ratio="1" strike="X" expiration="X">
		<leg type="P" ratio="1" strike="X" expiration="X">
	</legs>
</combination>
```

Каждый тег &lt;leg&gt; имеет обязательные атрибуты:
1. **type**: тип инструмента соответствующей компоненты описывается буквой из множества (**F** - фьючерс, **O** - опцион, **C** - колл опцион, **P** - пут опцион, **U** - инструмент отличный от опциона). Пут (**P**) и колл (**C**) опционы являются частными случаями опционов (**O**).

2. **ratio:** вес соответсвующей компоненты описывается произвольным вещественным числом. Допускается указывать как точный вес, так и просто его знак - &quot;+&quot; или &quot;-&quot;, означающие, что вес положителен или отрицателен.

Каждый лег может иметь дополнительные атрибуты описывающие свойства компоненты:
1. **strike**: цена исполнения обозначается заглавной буквой латинского алфавита. Те компоненты у которых задан этот атрибут и буквенные обозначения равны должны иметь одинаковую цену исполнения. Атрибут может быть задан только для опционов.

2. **strike\_offset**: описывает насколько цена исполнения компоненты дожна быть больше/меньше, чем у предыдущего опциона, для которого этот атрибут не описан. Представляет собой строку из символов &quot;+&quot; или строку из символов &quot;-&quot;. Для наглядного пояснения, приведем пример:
```xml
	<!-- ... -->
                <leg type="P" ratio="1" />
                <leg type="P" ratio="1" strike_offset="+"/>
                <leg type="P" ratio="1" strike_offset="+"/>
                <leg type="P" ratio="1" strike_offset="++"/>
                <leg type="С" ratio="1" />
                <leg type="С" ratio="1" strike_offset="-"/>
	<!-- ... -->
```
В данном примере цена исполнения первой компоненты может быть произвольной, цены исполнения второй и третьей компоненты должны быть одинаковы (одинаковые длины означают одинаковое смещение), но больше чем первой. Цена исполнения четвертой компоненты должна быть больше чем цены исполнения второй и третьей. Цена исполнения пятой компоненты может быть произвольной. Цена исполнения шестой компоненты должна быть меньше чем цена исполнения пятой. Атрибут может быть задан только для опционов.

3. **expiration**: аналогичен атрибуту strike, описывающий в том же формате дату истечения инструмента.

4. **expiration\_offset**: практически аналогичен атрибуту strike\_ffset. Помимо строчек из символов &quot;+&quot; и &quot;-&quot; может содержать контретное смещение в виде &quot;[N]{d,m,q,y}&quot;, где N - натуральное число (может быть пропущено, по умолчанию равно единице), &quot;d&quot; - день, &quot;m&quot; - месяц, &quot;q&quot; - квартал, &quot;y&quot; - год. Отметим, что expiraion\_offset=&quot;q&quot; в отличии от expiraion\_offset=&quot;3m&quot; означает дату истечения не ровно через три месяца (день в день), а истечение в следущем квартале, т.е. день может точно не совпадать, главное, чтобы разница в месяцах была равна трем.

XML-ресурс с описанием типов комбинаций расположен в репозитории.

## Формат ввода вывода

 Первая строка содержит число N - количество компонент (2 ≤ N ≤ 100000). Далее в N строках идет описание компонент:

type weight expiration strike, где type - символ &quot;C&quot;, &quot;P&quot;, &quot;O&quot;, &quot;F&quot;, &quot;U&quot;, weight - вес компоненты, expiration - дата исполнения в формате yyyy-mm-dd, strike - цена исполнения. Цена исполнения задается только для опционов.

 Если комбинация была классифицирована в первой строке вывести полное имя типа комбинации. В следующих строках следует вывести перестановку чисел от 1 до N - порядок компонент, в котором их следует рассматривать (согласно порядку описанному в ресурсе).

 Если комбинация не была классифицирована следует вывести одну строку - &quot;Unclassified&quot;.

Eсли не удается однозначно определить тип комбинации, то приоритет имеет тот тип, что описан в ресурсе раньше.

## Пример

| **Ввод** | **Вывод** |
| --- | --- |
| 2<br>P 1.0 100 2013-10-19<br>C 1.0 100 2013-10-19 | Straddle<br>2<br>1 |
| 3<br>F 1.0 2013-10-19<br>F -2.0 2013-11-16<br>F 1.0 2013-12-21 | Future butterfly<br>1<br>2<br>3|
| 2<br>P 1.0 100 2013-10-18<br>C 1.0 100 2013-10-19 | Unclassified |

## Разбор XML
Можно использовать стороннюю библиотеку для разбора XML, например, [Pugixml](https://pugixml.org/) или [LibXML2](http://xmlsoft.org/).

Нужно либо подключить такую библиотеку как Git submodule, либо положить её исходники в репозиторий. В обоих случаях каталог с библиотекой должен называться
`xml` и содержать корректный проект CMake, а добавление нужно произвести отдельным коммитом в ветку `master`, до создания ветки с решением задачи.
В CMakeLists.txt нужно раскомментировать строчку `add_library(xml_lib ALIAS xxx)`, где `xxx` заменить на основную цель сборки библиотеки из её проекта CMake.
